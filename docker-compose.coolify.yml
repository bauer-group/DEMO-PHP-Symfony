# =============================================================================
# Docker Compose - Production / Coolify / Standalone
# =============================================================================
# Usage:
#   docker compose up -d
#   docker compose logs -f
#   docker compose down
#
# For Coolify deployment, set environment variables in Coolify dashboard.
# =============================================================================

name: ${STACK_NAME:-todo-app}

services:
  # ---------------------------------------------------------------------------
  # PHP Application Server
  # ---------------------------------------------------------------------------
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: production
    container_name: ${STACK_NAME:-todo-app}_app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
    environment:
      - APP_ENV=${APP_ENV:-prod}
      - APP_SECRET=${APP_SECRET:-change-me-in-production}
      - APP_DEBUG=${APP_DEBUG:-0}
      - DATABASE_URL=mysql://${MYSQL_USER:-todo_user}:${MYSQL_PASSWORD:-todo_password}@database:3306/${MYSQL_DATABASE:-todo_db}?serverVersion=8.0&charset=utf8mb4&sslmode=disabled
      - TIME_ZONE=${TIME_ZONE:-Etc/UTC}
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      start_period: 30s
      retries: 3
    networks:
      - internal

  # ---------------------------------------------------------------------------
  # MySQL Database
  # ---------------------------------------------------------------------------
  database:
    image: mysql:8.0
    container_name: ${STACK_NAME:-todo-app}_database
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_secret_password}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-todo_db}
      - MYSQL_USER=${MYSQL_USER:-todo_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-todo_password}
      - TZ=${TIME_ZONE:-Etc/UTC}
    volumes:
      - database_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_secret_password}"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5
    networks:
      - internal

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  internal:
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  database_data:
    name: ${STACK_NAME:-todo-app}_database_data
